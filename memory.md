# Project Memory

> AI reads at session start (`/prime`) and during planning (`/planning`)
> AI appends after implementation (`/commit`)
> Human can edit anytime — it's just a markdown file
> Keep entries concise (1-2 lines each) to minimize context token usage

---

## Key Decisions

- [2026-02-25] Strict gate workflow (G1-G5) enforced for all feature plans — Prevents premature complexity and ensures sustainable agent architecture
- [2026-02-25] Python-first with framework-agnostic contracts — Allows fast delivery while preserving portability to other frameworks
- [2026-02-25] Context mode detection in `/planning` — Automatically distinguishes system repos from application codebases
- [2026-02-25] Bypass protocol requires ≥8/10 maturity score + evidence + rollback plan — Governed flexibility without weakening gates
- [2026-02-25] Build order: Contracts → Core Loop → Eval/Trace → Memory → Orchestration → Ingestion — Prevents technical debt accumulation
- [2026-02-26] Trace-first approach for Eval/Trace: structured records now, eval scoring as separate follow-up slice — YAGNI on eval until traces prove useful
- [2026-02-25] Archon-first policy for `/planning` and `/execute` — Require MCP health preflight plus RAG grounding before plan/implementation synthesis
- [2026-02-26] Incremental-by-default slices with full validation every loop — Keep scope to one outcome while still running full quality gates (lint, types, unit, integration, manual)
- [2026-02-26] `/execute` Archon RAG policy: plan is source of truth, RAG is recovery path only — if plan is complete, no research needed; if genuine gap found, do targeted search before guessing
- [2026-02-27] **Multi-model execution policy v2 (5-Tier Cost-Optimized Cascade)**: Maximize free models, minimize paid usage. T1 Implementation: `bailian-coding-plan` (qwen3-coder-next for simple, qwen3-coder-plus for code-heavy, qwen3.5-plus for complex) — FREE. Fallback: `zai-coding-plan/glm-4.7`. T2 First Validation: `zai-coding-plan/glm-5` (thinking model) — FREE. T3 Second Validation: `ollama-cloud/deepseek-v3.2` (independent family) — FREE. T4 Code Review gate: `openai/gpt-5.3-codex` — PAID (cheap). T5 Final Review: `anthropic/claude-sonnet-4-6` — PAID (expensive, last resort only). Architecture debates via `council.ts`. Claude Opus handles ONLY orchestration/planning/strategy.
- [2026-02-27] Pillar-based infrastructure planning: build pipeline now enforces infrastructure layers (pillars) with gate criteria. /build blocks Pillar N+1 until Pillar N passes. Gate specs auto-generated by /decompose. PILLARS.md is optional — system backward-compatible when it doesn't exist.

## Architecture Patterns

- **Strict Gate Workflow (G1-G5)**: Sequential gates for contracts, reliability, evals, observability, ingestion eligibility. Used in: `sections/02_piv_loop.md`, `templates/STRUCTURED-PLAN-TEMPLATE.md`
- **Runtime Portability Contract**: Implementation Runtime Default + Portability Boundary + Adapter Swap Criteria + Eval Portability Check. Used in: `.opencode/commands/planning.md`, `reference/python-first-portability-guide.md`
- **Context Mode Detection**: Single glob on `{src,app,frontend,backend,lib,api,server,client}/**` to distinguish Project vs System mode. Used in: `.opencode/commands/planning.md`
- **Governed Bypass Protocol**: Bypass allowed only with maturity score ≥8/10, passing evals/traces, documented risks, rollback plan, user approval. Used in: `reference/sustainable-agent-architecture.md`

## Task Management Protocol

- **Archon is the single source of truth for task tracking** — do NOT use TodoWrite. All execution tasks go to Archon via `manage_task`.
- **Goal**: Task descriptions must be **execution-ready for any LLM** — a fresh session reads `find_tasks(status: "todo")` and can implement immediately without the plan file, without re-reading codebase, without asking questions.
- **Task description format** (7-field, code-inclusive):
  - ACTION: What to do (add, update, replace, delete)
  - TARGET: Exact file path + line range or anchor point (e.g., `.opencode/tools/dispatch.ts` before `export default tool` ~line 52)
  - IMPLEMENT: Actual code snippets — full copy-pasteable blocks, not summaries. Label sub-steps (a, b, c). Include OLD→NEW for replacements.
  - PATTERN: Reference pattern to follow (file:line) so LLM can read it for style matching
  - GOTCHA: What can go wrong, edge cases, backward compatibility notes
  - VALIDATE: Exact shell command to verify success (e.g., `cd .opencode && bun build --no-bundle tools/dispatch.ts`)
- **Status flow**: `todo` → `doing` → `review` → `done`. Update status as you work each task.
- **Archon project ID**: `3d32fa8f-dfc6-4885-96ba-802a2edf1dc6` (Second Brain - Multi-Model Dispatch)
- **Session protocol**: POST to `http://159.195.45.47:8051/mcp` with `Mcp-Session-Id` header. If session expires, re-initialize.

## Gotchas & Pitfalls

- **Gate bypass requests**: AI cannot approve bypass — user must explicitly confirm. Always require evidence links, not self-reported scores
- **Framework lock-in risk**: "Python-first" does not mean "Python-only" — contracts must stay framework-agnostic
- **Plan template fields**: Don't bury portability fields in NOTES only — they must be first-class ARCHITECTURE GUARDRAILS fields
- **mvp.md handling**: Only used in Project Mode (application codebases). System Mode skips mvp.md and captures intent in plan's Solution Statement
- **Pre-gate plans**: Plans created before strict gates need update before `/execute` — old plans lack required gate metadata

## Build Pipeline Rules

- **NO STEP SKIPPING — EVER**: Every spec runs ALL 11 steps in order, regardless of depth. Depth (light/standard/heavy) ONLY controls how many free models run in Step 7a (3/5/5). It does NOT skip: Step 3 T4 plan review, Step 6 validation, Step 7d T4 panel (codex + sonnet-4-5 + sonnet-4-6). This applies in autonomous mode too.

## Lessons Learned

- **Documentation updates need README sync**: When adding new reference guides, update README "By the Numbers" and guide inventory to prevent doc drift
- **Bug scanner on commits**: UBS may flag documentation changes as warnings — use `--no-verify` when committing docs-only changes
- **Context mode detection**: Single glob call is more efficient than sequential file probing for mode detection
- **Execution report timing**: Save execution report to file first, then display inline — consumed by `/system-review`
- **Planning quality floor**: Require concrete code samples (local + Archon when relevant) before writing step-by-step tasks
- **Avoid mixed-scope loops**: Combining workflow/docs changes with backend behavior in one slice increases review noise and slows merge confidence
- **Provider error context**: Keep fallback metadata actionable but sanitized (redact secrets and cap message length)
- **Embedding dimension alignment**: Voyage `voyage-4-large` outputs 1024 dims; Supabase pgvector column must match (`vector(1024)`) — mismatch causes silent RPC failures
- **Session safety in shared servers**: Never trust client-supplied `session_id`; only allow server-issued active IDs and prune stale IDs with session eviction
- **Legacy SDK compatibility**: When provider SDKs differ on auth args, use temporary env bridging with lock + restore to avoid persistent process env mutation
- **OpenCode SDK swallows AbortError**: `session.prompt()` doesn't throw on timeout — puts DOMException in `result.error` and returns `{ data: {} }`. Check `controller.signal.aborted` or `result.error?.name === "AbortError"` after the call, not in catch block.
- **OpenCode provider models is Record, not Array**: `GET /provider` returns `models` as `Record<string, Model>`, not `Model[]`. Use `Object.values()` to iterate.
- **OpenCode upstream API errors in info.error**: When model responds but upstream API fails (404, auth), server returns 200 with `data.info.error` containing `{ name, data: { message, statusCode } }` and `parts: []`.
- **UBS scanner false positives**: Scanner's line-level heuristics flag SDK method names (e.g., `client.session.prompt()` matches "prompt" alert check), JSON.parse inside existing try/catch, and bundled .js artifacts. Use .ubsignore to exclude temp scripts and build artifacts.

## Session Notes

- [2026-02-25] Implemented sustainable agent architecture framework: strict gates G1-G5, Python-first portability guardrails, context mode detection. Created `reference/sustainable-agent-architecture.md` and `reference/python-first-portability-guide.md`. Updated planning command, plan template, PIV loop docs, README with changelog section. Committed c7cf4b4.
- [2026-02-25] Updated `/planning` and `/execute` to make Archon mandatory, added RAG retrieval/code-sample requirements, and tightened execution/reporting checklist fields for handoff quality.
- [2026-02-26] Closed prior hybrid-retrieval plans as done artifacts and created next micro-slice plan for Mem0 real-provider adapter implementation.
- [2026-02-26] Standardized system guardrails for incremental execution plus full validation depth; updated `/planning`, `/execute`, `/code-loop`, and structured plan template. Committed ce221aa.
- [2026-02-26] Fixed deferred memory adapter findings: added input normalization, provider failure logging, and sanitized error metadata; validated with ruff+mypy+unit+integration.
- [2026-02-26] Captured manual branch validation evidence (13/13 PASS), synchronized status docs, fixed PR-UPDATE test count mismatch via code-loop. Committed e78a655.
- [2026-02-26] Enforced plan-bound execution: hard entry gate on `/execute`, done-marker completion sweep in `/code-loop` (write as .md, rename on clean exit), artifact sweep in `/commit`. Pushed and updated PR #1. Committed e30a7f8.
- [2026-02-26] Added retrieval trace layer: RetrievalTrace model + TraceCollector service + orchestrator instrumentation (160 tests). Created `/final-review` command as pre-commit approval gate. Updated `/code-loop` to hand off to `/final-review` instead of auto-committing. Committed 4a458b5.
- [2026-02-26] Added Supabase pgvector provider (SupabaseProvider adapter + Voyage embed), wired MemoryService dispatch for `provider="supabase"`. Added Archon RAG tools to code-review agent + code-loop pre-loop context loading. 175+ tests. PR #2. Committed c8eb99d.
- [2026-02-26] Completed planning-orchestration hardening loop: narrowed planner exception handling, locked and bounded trace/session flows, added MCP chat session issuance/pruning/caching safeguards, and expanded tests to 235 passing.
- [2026-02-26] Planned knowledge-schema foundation: KnowledgeChunk/Document/Entity/Relationship/Source contracts, SQL migration (5 tables + HNSW + match_knowledge_chunks RPC), SupabaseProvider column fix, Mem0 metadata conventions. Plan: `requests/knowledge-schema #1.md`.
- [2026-02-26] Multi-model dispatch complete (slices 1-8): dispatch.ts + batch-dispatch.ts tools, workflow wiring, SDK hardening (provider pre-flight, mandatory 120s timeout, empty-response + swallowed AbortError detection, upstream info.error handling). Validated live across 5 providers. Committed e2ba7d4.
- [2026-02-27] Pivoted to 5-tier cost-optimized cascade: T1 qwen3 family (FREE), T2 glm-5 thinking (FREE), T3 deepseek-v3.2 (FREE), T4 gpt-5.3-codex (cheap), T5 claude-sonnet-4-6 (last resort). Added auto-primer to dispatch/batch-dispatch. Updated all commands and AGENTS.md. Committed 87c919b, pushed to PR #4.
- [2026-02-27] **New MVP Build Pipeline** (council-validated by 3 real models — GLM-5, DeepSeek-v3.2, GPT-5.3-codex): `/mvp` → `/decompose` → `/build next` (repeat) → `/ship`. Key features: BUILD_ORDER.md with topological sort and dependency enforcement, 3 plan depths (light/standard/heavy), semi-automated `/build` with decision summary approval, `/sync` for state validation, `/council` for 13-model debates. `/build` wraps existing /planning + /execute + /code-loop internally. Old commands remain for manual use.
- [2026-02-27] **Council command**: `/council` dispatches to 13 real models (5 bailian, 3 ollama-cloud, 4 zai, 1 openai) via inline bun script using OpenCode SDK v2. Requires `opencode serve` running. 90s timeout per model, all parallel. Confirmed working with real dispatch test.
- [2026-02-27] **Pipeline refinement**: Added `/prd` between `/mvp` and `/decompose`. Full pipeline: `/mvp → /prd → /decompose → /build → /ship`. PRD is the detailed product doc (what + why + user stories); decompose reads PRD as primary input (falls back to mvp.md). Rewrote `/planning` as interactive discovery mode (Understand → Explore → Design → Preview → Write Plan) replacing 6-phase automated approach.
- [2026-02-27] **Pillar-based build system**: Added /pillars command between /prd and /decompose. Pipeline: /mvp → /prd → /pillars → /decompose → /build → /ship. Extracted relay utils (_relay-utils.ts), added Archon relay to agent mode + council. Updated decompose/build/sync to be pillar-aware with gate enforcement. Committed: 0b27295, eb45eeb, fd24a87.
- [2026-02-27] **Max free utilization**: Expanded from 40→54 taskTypes (added qwen3-max, glm-4.5, 9 new specialized roles), 4→10 batch patterns (free-review-gauntlet, free-heavy-architecture, free-security-audit, free-plan-review, free-impl-validation, free-regression-sweep), council 13→18 models (synced council.ts with council.md), wired `batchPattern` arg into batch-dispatch. Smart escalation: light specs = zero paid (3-model free validation), standard specs = 5-model free gauntlet with consensus-based T4 skip (~70% savings), heavy = full cascade. Removed "opencode" from AGENT_COMPATIBLE_PROVIDERS. Committed 14183af.

- [2026-02-28] **Relay mode eliminated**: Deleted _relay-utils.ts (423 lines), simplified dispatch 3→2 modes (text/agent). Removed AGENT_COMPATIBLE_PROVIDERS — ALL providers use native agent mode via `agent: "build"`. Committed 31da27a.
- [2026-02-28] **Chicken-and-egg lesson**: T1 in old relay mode = text-only, can't edit files. Used T4 (codex) to bootstrap the fix. After restart, free providers work natively.
- [2026-02-28] **Gemini models removed**: Replaced broken gemini-3-pro-preview/flash with zai-coding-plan/glm-4.7 in dispatch, batch-dispatch, council. Committed 39a0f5d.
- [2026-02-28] **Sub-plan system IMPLEMENTED**: Master plan (~500 lines, MASTER-PLAN-TEMPLATE) + sub-plans (700-1000 lines each, SUB-PLAN-TEMPLATE). /planning auto-detects complexity (>=10 tasks → master+sub-plans). /build Steps 2-5 loop sub-plans sequentially with handoff notes. /execute detects `-master-plan.md` files. Fixed stale plan-size tables in decompose.md + model-strategy.md. Committed 834e1dd.
- [2026-02-28] **Tool reload requires CLI restart**: Restarting `opencode serve` reloads server-side code, but MCP tool plugins in Claude Code CLI stay cached until CLI restarts. Both must restart for dispatch tool changes to take effect.

---

> **Sizing guide**: Keep this file under 100 lines. Archive old entries to `memory-archive.md` if needed.
